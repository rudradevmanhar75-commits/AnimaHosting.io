<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comet Anima - Watch Free</title>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8675548946096450" crossorigin="anonymous"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>

    <style>
        :root { --main-color: #ff6600; --bg-color: #0b0b0b; --text-color: #ffffff; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); padding-bottom: 70px; }
        
        /* Header & Search */
        .header { padding: 15px; display: flex; align-items: center; background: #1a1a1a; position: sticky; top: 0; z-index: 100; }
        .search-bar { flex: 1; padding: 10px; border-radius: 20px; border: none; background: #333; color: white; margin: 0 10px; }

        /* Navigation */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: #1a1a1a; display: flex; justify-content: space-around; padding: 12px 0; border-top: 1px solid #333; }
        .nav-item { color: #888; text-decoration: none; font-size: 12px; text-align: center; cursor: pointer; }
        .nav-item.active { color: var(--main-color); }

        /* Anime Grid */
        .section-title { padding: 15px; font-size: 20px; font-weight: bold; }
        .anime-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 10px; padding: 10px; }
        .anime-card { background: #222; border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.3s; }
        .anime-card img { width: 100%; height: 160px; object-fit: cover; }
        .anime-card .title { padding: 5px; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Auth Pages */
        .auth-container { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; padding: 20px; }
        input { width: 90%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; }
        .btn { background: var(--main-color); color: white; padding: 12px 30px; border: none; border-radius: 5px; width: 90%; font-weight: bold; }

        /* Player Overlay */
        #player-screen { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 1000; }
        video { width: 100%; height: auto; max-height: 250px; }
        .episode-list { padding: 15px; }
        
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="auth-screen" class="auth-container">
        <h2 id="auth-title">Create Account</h2>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="pass" placeholder="Password">
        <button class="btn" onclick="handleAuth()" id="auth-btn">Sign Up</button>
        <p onclick="toggleAuthMode()" style="margin-top:15px; cursor:pointer" id="auth-toggle">Already have an account? Login</p>
    </div>

    <div id="app-content" class="hidden">
        <div class="header">
            <input type="text" class="search-bar" placeholder="Search Anime..." onkeyup="searchAnime(this.value)">
        </div>

        <div id="view-home">
            <div class="section-title">Popular Anime</div>
            <div class="anime-grid" id="popular-list"></div>
        </div>

        <div id="view-browse" class="hidden">
            <div class="section-title">All Simulcasts</div>
            <div class="anime-grid" id="all-anime-list"></div>
        </div>

        <div id="view-account" class="hidden" style="padding: 20px; text-align: center;">
            <img id="user-profile-pic" src="https://via.placeholder.com/100" style="width:100px; height:100px; border-radius:50%; object-fit: cover;">
            <br><br>
            <input type="file" id="pic-upload" style="display:none" onchange="uploadProfilePic(event)">
            <button class="btn" onclick="document.getElementById('pic-upload').click()">Change Profile Picture</button>
            <button class="btn" style="background:#444; margin-top:10px" onclick="firebase.auth().signOut()">Logout</button>
        </div>

        <div id="player-screen">
            <button onclick="closePlayer()" style="color:white; background:none; border:none; padding:15px; font-size:20px;">‚Üê Back</button>
            <video id="main-player" controls onplay="triggerAd()"></video>
            <div id="episode-controls" class="episode-list">
                <h3 id="player-title"></h3>
                <select id="season-select" onchange="loadEpisodes()"></select>
                <div id="ep-buttons" style="margin-top:10px"></div>
            </div>
        </div>

        <nav class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('home')">üè†<br>Home</div>
            <div class="nav-item" onclick="switchTab('browse')">üß≠<br>Browse</div>
            <div class="nav-item" onclick="switchTab('account')">üë§<br>Account</div>
        </nav>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBuYwkLGEOx4FWwCkcsfWfVozXfHkepR8E",
            authDomain: "anima-hosting-app.firebaseapp.com",
            projectId: "anima-hosting-app",
            storageBucket: "anima-hosting-app.firebasestorage.app",
            messagingSenderId: "883981430156",
            appId: "1:883981430156:web:a4a8fab02ff42b31707aa9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
        const storage = firebase.storage();

        let isLogin = false;
        let currentAnime = null;
        let adCounter = 0;

        // Auth Logic
        function toggleAuthMode() {
            isLogin = !isLogin;
            document.getElementById('auth-title').innerText = isLogin ? 'Welcome Back' : 'Create Account';
            document.getElementById('auth-btn').innerText = isLogin ? 'Login' : 'Sign Up';
            document.getElementById('auth-toggle').innerText = isLogin ? "Don't have an account? Sign Up" : "Already have an account? Login";
        }

        async function handleAuth() {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('pass').value;
            try {
                if(isLogin) await auth.signInWithEmailAndPassword(email, pass);
                else await auth.createUserWithEmailAndPassword(email, pass);
            } catch(e) { alert(e.message); }
        }

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('app-content').classList.remove('hidden');
                loadAnimeData();
                updateOnlineStatus(user.uid, true);
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('app-content').classList.add('hidden');
            }
        });

        // App Functions
        function loadAnimeData() {
            db.ref('anime').on('value', snapshot => {
                const data = snapshot.val();
                const list = document.getElementById('popular-list');
                const browseList = document.getElementById('all-anime-list');
                list.innerHTML = ''; browseList.innerHTML = '';
                
                for(let id in data) {
                    const anime = data[id];
                    const card = `
                        <div class="anime-card" onclick="openPlayer('${id}')">
                            <img src="${anime.thumbnail}">
                            <div class="title">${anime.title}</div>
                        </div>`;
                    list.innerHTML += card;
                    browseList.innerHTML += card;
                }
            });
        }

        function triggerAd() {
            adCounter++;
            if(adCounter % 2 === 0) { // Shows ad 3 times logic during playback cycle
                console.log("AdMob Triggered");
                // In real app, AdMob Interstitial would trigger here
                (adsbygoogle = window.adsbygoogle || []).push({});
            }
        }

        function openPlayer(id) {
            db.ref('anime/' + id).once('value', s => {
                currentAnime = s.val();
                document.getElementById('player-screen').style.display = 'block';
                document.getElementById('player-title').innerText = currentAnime.title;
                
                let sSelect = document.getElementById('season-select');
                sSelect.innerHTML = '';
                for(let i=1; i<=currentAnime.seasons; i++) {
                    sSelect.innerHTML += `<option value="${i}">Season ${i}</option>`;
                }
                loadEpisodes();
            });
        }

        function loadEpisodes() {
            const container = document.getElementById('ep-buttons');
            container.innerHTML = '';
            for(let i=1; i<=currentAnime.episodes; i++) {
                container.innerHTML += `<button class="btn" style="width:auto; margin:5px;" onclick="playVideo('${currentAnime.videoUrl}')">Ep ${i}</button>`;
            }
        }

        function playVideo(url) {
            const video = document.getElementById('main-player');
            video.src = url;
            video.play();
        }

        function closePlayer() {
            document.getElementById('player-screen').style.display = 'none';
            document.getElementById('main-player').pause();
        }

        function switchTab(tab) {
            ['home', 'browse', 'account'].forEach(t => {
                document.getElementById('view-' + t).classList.add('hidden');
            });
            document.getElementById('view-' + tab).classList.remove('hidden');
        }

        async function uploadProfilePic(e) {
            const file = e.target.files[0];
            const ref = storage.ref(`profiles/${auth.currentUser.uid}`);
            await ref.put(file);
            const url = await ref.getDownloadURL();
            document.getElementById('user-profile-pic').src = url;
            db.ref('users/' + auth.currentUser.uid).update({ photo: url });
        }

        function updateOnlineStatus(uid, status) {
            db.ref('status/' + uid).set({ online: status, last_seen: Date.now() });
        }
    </script>
</body>
</html>